
- name: Find existing AMI
  ec2_ami_facts:
    region: "{{region}}"
    filters:
      "tag:Name": "{{ ami_name }}"
  register: "base_ami"

- name: Remove existing AMI
  ec2_ami:
    image_id: "{{ base_ami['images'][0]['image_id'] }}"
    region: "{{ region }}"
    delete_snapshot: yes
    state: absent
  ignore_errors: true
  
- name: Create a new instance
  include: provision-instance.yml

- name: Update the instance
  include: update-instance.yml

- name: Register a new AMI
  ec2_ami:
    instance_id: "{{ instance_id }}"
    region: "{{ region }}"
    name: "{{ ami_name }}"
    tags:
      Name: "{{ ami_name }}"
    wait: yes

- name: Destroy the active instance
  include: destroy-instance.yml
